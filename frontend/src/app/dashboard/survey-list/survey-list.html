<h2 class="custom-title">Questionnaires</h2>

<!-- ðŸ“± Mobile View -->
<div *ngIf="!isLargeScreen" class="row row-cols-1 row-cols-md-2 g-4 mb-5">
  <div class="col" *ngFor="let questionnaire of visibleSurveys()">
    <div class="custom-dashboard-card">
      <h5 class="custom-dashboard-title">{{ questionnaire.question }}</h5>
      <div class="text-muted mb-2">
        {{ questionnaire.startTime | date: 'dd.MM.yyyy HH:mm' }} â€“ {{ questionnaire.endTime | date: 'dd.MM.yyyy HH:mm' }}
      </div>

      <div *ngFor="let answer of questionnaire.answers">
        <p class="mb-1" *ngIf="answer.answer">{{ answer.answer }}</p>
        <div class="custom-progress-container">
          <div
            class="custom-progress-bar"
            [style.width.%]="calculatePercentage(answer.totalVotes, questionnaire.answers)"
          ></div>
        </div>
        <p class="percentage-label text-end small">
          {{ calculatePercentage(answer.totalVotes, questionnaire.answers) }} %
        </p>
      </div>

      <!-- Live -->
      <div *ngIf="isCurrentlyLive(questionnaire)" class="text-center">
        <span class="live-label" style="display: inline;">Live</span>
        <span class="live-time" style="display: inline;">
    ends at <strong>{{ questionnaire.endTime | date: 'dd.MM.yyyy HH:mm' }}</strong>
  </span>
        <div style="margin-top: 0.5rem;">
          <button class="custom-btn" (click)="openEndSurveyPopup(questionnaire.questionnaireID, questionnaire.endTime)">
            Stop Questionnaire
          </button>
        </div>
      </div>

      <!-- Starts at -->
      <div *ngIf="isUpcoming(questionnaire)" class="text-center">
        <span class="live-label" style="display: inline;">Starts at</span>
        <span class="live-time" style="display: inline;">
    <strong>{{ questionnaire.startTime | date: 'dd.MM.yyyy HH:mm' }}</strong>
  </span>
      </div>

      <!-- Is closed -->
      <div *ngIf="isFinished(questionnaire)" class="status-closed text-center">
        <strong>Is closed</strong>
      </div>
    </div>
  </div>

  <div class="text-center mt-3" *ngIf="surveys().length > maxVisibleSurveys()">
    <button class="custom-btn" (click)="toggleShowAll()">
      {{ showAllSurveys() ? 'Show less' : 'Show more' }}
    </button>
  </div>
</div>

<!-- ðŸ–¥ï¸ Desktop View -->
<div *ngIf="isLargeScreen" class="carousel-flex-wrapper d-flex align-items-center justify-content-between mb-5">
  <button class="carousel-arrow" type="button" data-bs-target="#surveyCarousel" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Previous</span>
  </button>

  <div id="surveyCarousel" class="carousel slide w-100 mx-3" data-bs-ride="false">
    <div class="carousel-inner">
      <div class="carousel-item" *ngFor="let chunk of surveyChunks(); let i = index" [class.active]="i === 0">
        <div class="row row-cols-1 row-cols-md-3 g-4 justify-content-center">
          <div class="col" *ngFor="let questionnaire of chunk">
            <div class="custom-dashboard-card h-100 d-flex flex-column justify-content-between">
              <h5 class="question-header" [title]="questionnaire.question">
                {{ questionnaire.question }}
              </h5>
              <div class="text-muted mb-2">
                {{ questionnaire.startTime | date: 'dd.MM.yyyy HH:mm' }} â€“ {{ questionnaire.endTime | date: 'dd.MM.yyyy HH:mm' }}
              </div>

              <div class="answers-scrollbox">
                <div *ngFor="let answer of questionnaire.answers">
                  <p class="mb-1" *ngIf="answer.answer">{{ answer.answer }}</p>
                  <div class="custom-progress-container">
                    <div
                      class="custom-progress-bar"
                      [style.width.%]="calculatePercentage(answer.totalVotes, questionnaire.answers)"
                    ></div>
                  </div>
                  <p class="percentage-label text-end small">
                    {{ calculatePercentage(answer.totalVotes, questionnaire.answers) }} %
                  </p>
                </div>
              </div>

              <!-- Live -->
              <div *ngIf="isCurrentlyLive(questionnaire)" class="text-center">
                <span class="live-label">Live</span>
                <span class="live-time">
    ends at <strong>{{ questionnaire.endTime | date: 'dd.MM.yyyy HH:mm' }}</strong>
  </span>
                <div style="margin-top: 0.5rem;">
                  <button class="custom-btn" (click)="openEndSurveyPopup(questionnaire.questionnaireID, questionnaire.endTime)">
                    Stop Questionnaire
                  </button>
                </div>
              </div>

              <!-- Starts at -->
              <div *ngIf="isUpcoming(questionnaire)" class="text-center">
                <span class="live-label">Starts at</span>
                <span class="live-time">
    <strong>{{ questionnaire.startTime | date: 'dd.MM.yyyy HH:mm' }}</strong>
  </span>
              </div>

              <!-- Is closed -->
              <div *ngIf="isFinished(questionnaire)" class="status-closed text-center">
                <strong>Is closed</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button class="carousel-arrow" type="button" data-bs-target="#surveyCarousel" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Next</span>
  </button>
</div>

<!-- ðŸ§± Survey End Popup -->
<app-end-survey-popup
  *ngIf="showEndSurveyPopup"
  [surveyIDToEnd]="selectedSurveyID"
  [surveyEndTime]="selectedSurveyEndTime"
  (close)="closeEndSurveyPopup()"
></app-end-survey-popup>
