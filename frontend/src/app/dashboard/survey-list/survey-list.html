<h2 class="custom-title">Questionnaires</h2>

<!-- 📱 Mobile: normale Liste -->
<div *ngIf="!isLargeScreen" class="row row-cols-1 row-cols-md-2 g-4 mb-5">
  <div class="col" *ngFor="let questionnaire of visibleSurveys">
    <div class="custom-dashboard-card">
      <h5 class="custom-dashboard-title">{{ questionnaire.question }}</h5>
      <div class="text-muted mb-2">
        {{ questionnaire.startTime | date: 'dd.MM.yyyy HH:mm' }} – {{ questionnaire.endTime | date: 'dd.MM.yyyy HH:mm' }}
      </div>

      <div *ngFor="let answer of questionnaire.answers">
        <p class="mb-1">{{ answer.answer }}</p>
        <div class="custom-progress-container">
          <div
            class="custom-progress-bar"
            [style.width.%]="calculatePercentage(answer.totalVotes, questionnaire.answers)"
          ></div>
        </div>
        <p class="percentage-label text-end small">
          {{ calculatePercentage(answer.totalVotes, questionnaire.answers) }} %
        </p>
      </div>

      <div *ngIf="questionnaire.isLive" class="status-live">Live</div>
      <div *ngIf="questionnaire.isLive">
        <button class="custom-btn" (click)="openEndSurveyPopup(questionnaire.questionnaireID, questionnaire.endTime)">
          STOP Questionnaire
        </button>
      </div>
      <div *ngIf="!questionnaire.isLive">
        <strong>Winner:</strong> {{ getWinner(questionnaire.answers) }}
      </div>
    </div>
  </div>

  <div class="text-center mt-3" *ngIf="surveys.length > maxVisibleSurveys">
    <button class="custom-btn" (click)="toggleShowAll()">
      {{ showAllSurveys ? 'Weniger anzeigen' : 'Mehr anzeigen' }}
    </button>
  </div>
</div>

<!-- 🖥️ Desktop: Carousel -->
<div *ngIf="isLargeScreen" class="carousel-flex-wrapper d-flex align-items-center justify-content-between mb-5">
  <button class="carousel-arrow" type="button" data-bs-target="#surveyCarousel" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Vorherige</span>
  </button>

  <div id="surveyCarousel" class="carousel slide w-100 mx-3" data-bs-ride="false">
    <div class="carousel-inner">
      <div class="carousel-item" *ngFor="let chunk of surveyChunks; let i = index" [class.active]="i === 0">
        <div class="row row-cols-1 row-cols-md-3 g-4 justify-content-center">
          <div class="col" *ngFor="let questionnaire of chunk">
            <div class="custom-dashboard-card h-100 d-flex flex-column justify-content-between">
              <h5 class="question-header" [title]="questionnaire.question">
                {{ questionnaire.question }}
              </h5>
              <div class="text-muted mb-2">
                {{ questionnaire.startTime | date: 'dd.MM.yyyy HH:mm' }} – {{ questionnaire.endTime | date: 'dd.MM.yyyy HH:mm' }}
              </div>

              <div class="answers-scrollbox">
                <div *ngFor="let answer of questionnaire.answers">
                  <p class="mb-1">{{ answer.answer }}</p>
                  <div class="custom-progress-container">
                    <div
                      class="custom-progress-bar"
                      [style.width.%]="calculatePercentage(answer.totalVotes, questionnaire.answers)"
                    ></div>
                  </div>
                  <p class="percentage-label text-end small">
                    {{ calculatePercentage(answer.totalVotes, questionnaire.answers) }} %
                  </p>
                </div>
              </div>

              <div *ngIf="questionnaire.isLive" class="status-live">Live</div>
              <div *ngIf="questionnaire.isLive">
                <button class="custom-btn" (click)="openEndSurveyPopup(questionnaire.questionnaireID, questionnaire.endTime)">
                  STOP Questionnaire
                </button>
              </div>
              <div *ngIf="!questionnaire.isLive" class="winner-line" [title]="getWinner(questionnaire.answers)">
                <strong>{{ isDraw(questionnaire.answers) ? 'Draw' : 'Winner' }}:</strong>
                {{ getWinner(questionnaire.answers) }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button class="carousel-arrow" type="button" data-bs-target="#surveyCarousel" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Nächste</span>
  </button>
</div>

<!-- 🧱 Pop-up für Survey-Ende -->
<app-end-survey-popup
  *ngIf="showEndSurveyPopup"
  [surveyIDToEnd]="selectedSurveyID"
  [surveyEndTime]="selectedSurveyEndTime"
  (close)="closeEndSurveyPopup()"
></app-end-survey-popup>
