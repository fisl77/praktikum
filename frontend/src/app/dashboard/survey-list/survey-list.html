<div class="event-header-row">
  <h2 class="custom-title">
    Questionnaires
    <span class="info-tooltip">?
      <span class="tooltip-text">During a questionnaire you can define a question and possible answers for your community to vote on.</span>
    </span>
  </h2>
</div>

<!-- ðŸ“± Mobile View: Wenn Surveys vorhanden -->
@if (!isLargeScreen && surveys().length > 0) {
  <div class="row row-cols-1 row-cols-md-2 g-4 mb-5">
    @for (questionnaire of visibleSurveys(); track questionnaire) {
      <div class="col">
        <div class="custom-dashboard-card">
          <h5 class="custom-dashboard-title">{{ questionnaire.question }}</h5>
          <div class="text-muted mb-2">
            {{ questionnaire.startTime | date: 'dd.MM.yyyy HH:mm' }} â€“ {{ questionnaire.endTime | date: 'dd.MM.yyyy HH:mm' }}
          </div>
          @for (answer of questionnaire.answers; track answer) {
            <div>
              @if (answer.answer) {
                <p class="mb-1">{{ answer.answer }}</p>
              }
              <div class="custom-progress-container">
                <div class="custom-progress-bar" [style.width.%]="calculatePercentage(answer.totalVotes, questionnaire.answers)"></div>
              </div>
              <p class="percentage-label text-end small">{{ calculatePercentage(answer.totalVotes, questionnaire.answers) }} %</p>
            </div>
          }
          @if (!questionnaire.isLive) {
            <div class="winner-line text-center" [title]="getWinner(questionnaire.answers)">
              <strong>{{ isDraw(questionnaire.answers) ? 'Draw' : 'Winner' }}:</strong> {{ getWinner(questionnaire.answers) }}
            </div>
          }
          @if (isCurrentlyLive(questionnaire)) {
            <div class="text-center">
              <span class="live-label"><strong>Live</strong></span>
              <span class="live-time">ends at {{ questionnaire.endTime | date: 'dd.MM.yyyy HH:mm' }}</span>
              <div class="mt-2">
                <button class="custom-btn" (click)="openEndSurveyPopup(questionnaire.questionnaireID, questionnaire.endTime)">
                  Stop Questionnaire
                </button>
              </div>
            </div>
          } @else {
            <div class="button-placeholder"></div>
          }
          @if (isUpcoming(questionnaire)) {
            <div class="text-center mt-2">
              <span class="live-label"><strong>Starts at</strong></span>
              <span class="live-time">{{ questionnaire.startTime | date: 'dd.MM.yyyy HH:mm' }}</span>
            </div>
          }
          @if (isFinished(questionnaire)) {
            <div class="status-closed text-center mt-2">
              <strong>Is closed</strong>
            </div>
          }
        </div>
      </div>
    }
    @if (surveys().length > maxVisibleSurveys()) {
      <div class="text-center mt-3">
        <button class="custom-btn" (click)="toggleShowAll()">
          {{ showAllSurveys() ? 'Show less' : 'Show more' }}
        </button>
      </div>
    }
  </div>
}

<!-- ðŸ“± Mobile View: Wenn KEINE Surveys vorhanden -->
@if (!isLargeScreen && surveys().length === 0) {
  <div class="row row-cols-1 mb-5">
    <div class="col">
      <div class="custom-dashboard-card d-flex justify-content-center align-items-center text-center">
        <p class="text-muted fs-5 m-0">No surveys created yet!</p>
      </div>
    </div>
  </div>
}

<!-- ðŸ–¥ï¸ Desktop Carousel -->
@if (isLargeScreen) {
  <div class="carousel-flex-wrapper d-flex align-items-center justify-content-between mb-5">
    <button class="carousel-arrow" (click)="prevSlide()">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <div class="carousel w-100 mx-3">
      <div class="carousel-inner">
        <!-- Wenn KEINE Umfragen vorhanden -->
        @if (surveyChunks().length === 0) {
          <div class="carousel-item active">
            <div class="row row-cols-1 row-cols-md-3 g-4 justify-content-center">
              <div class="col">
                <div class="custom-dashboard-card d-flex justify-content-center align-items-center text-center">
                  <p class="text-muted fs-5 m-0">No surveys created yet!</p>
                </div>
              </div>
            </div>
          </div>
        }
        <!-- Wenn Umfragen vorhanden -->
        @for (chunk of surveyChunks(); track chunk; let i = $index) {
          <div class="carousel-item" [class.active]="i === currentSlide()">
            <div class="row row-cols-1 row-cols-md-3 g-4 justify-content-center">
              @for (questionnaire of chunk; track questionnaire) {
                <div class="col">
                  <div class="custom-dashboard-card d-flex flex-column justify-content-between">
                    <h5 class="question-header" [title]="questionnaire.question">{{ questionnaire.question }}</h5>
                    <div class="text-muted mb-2">
                      {{ questionnaire.startTime | date: 'dd.MM.yyyy HH:mm' }} â€“ {{ questionnaire.endTime | date: 'dd.MM.yyyy HH:mm' }}
                    </div>
                    <div class="answers-scrollbox">
                      @for (answer of questionnaire.answers; track answer) {
                        <div>
                          @if (answer.answer) {
                            <p class="mb-1">{{ answer.answer }}</p>
                          }
                          <div class="custom-progress-container">
                            <div class="custom-progress-bar" [style.width.%]="calculatePercentage(answer.totalVotes, questionnaire.answers)"></div>
                          </div>
                          <p class="percentage-label text-end small">{{ calculatePercentage(answer.totalVotes, questionnaire.answers) }} %</p>
                        </div>
                      }
                    </div>
                    @if (isCurrentlyLive(questionnaire)) {
                      <div class="text-center mt-2">
                        <div class="mt-2">
                          <button class="custom-btn" (click)="openEndSurveyPopup(questionnaire.questionnaireID, questionnaire.endTime)">
                            Stop Questionnaire
                          </button>
                        </div>
                        <span class="live-label"><strong>Live</strong></span>
                        <span class="live-time">ends at {{ questionnaire.endTime | date: 'dd.MM.yyyy HH:mm' }}</span>
                      </div>
                    } @else {
                      <div class="button-placeholder"></div>
                    }
                    @if (isUpcoming(questionnaire)) {
                      <div class="text-center mt-2">
                        <div class="mt-2">
                          <button class="custom-btn" (click)="openEndSurveyPopup(questionnaire.questionnaireID, questionnaire.endTime)">
                            Stop Questionnaire
                          </button>
                        </div>
                        <span class="live-label"><strong>Starts at</strong></span>
                        <span class="live-time">{{ questionnaire.startTime | date: 'dd.MM.yyyy HH:mm' }}</span>
                      </div>
                    }
                    @if (isFinished(questionnaire)) {
                      <div class="status-closed text-center mt-2">
                        @if (!questionnaire.isLive) {
                          <div  [title]="getWinner(questionnaire.answers)">
                            <strong>{{ isDraw(questionnaire.answers) ? 'Draw' : 'Winner' }}:</strong> {{ getWinner(questionnaire.answers) }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
    <button class="carousel-arrow" (click)="nextSlide()">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>
}

<!-- ðŸ“¤ Survey-End-Popup -->
@if (showEndSurveyPopup) {
  <app-end-survey-popup
    [surveyIDToEnd]="selectedSurveyID"
    [surveyEndTime]="selectedSurveyEndTime"
    (close)="closeEndSurveyPopup()"
    />
}
